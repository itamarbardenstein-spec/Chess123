<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="Chess.Views.GamePage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:m="clr-namespace:Chess.Models"
    xmlns:vm="clr-namespace:Chess.ViewModel"
    xmlns:logic="clr-namespace:Chess.ModelsLogic"
    Title="GamePage"
    x:DataType="vm:GamePageVM">
    <ContentPage.Background>
        <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
            <GradientStop Offset="0.0" Color="MidnightBlue" />
            <GradientStop Offset="0.5" Color="SteelBlue" />
            <GradientStop Offset="1.0" Color="MidnightBlue" />
        </LinearGradientBrush>
    </ContentPage.Background>

    <VerticalStackLayout
        Padding="10"
        Spacing="0"
        VerticalOptions="Center">

        <Grid
            Margin="0,0,0,8"
            ColumnDefinitions="*, Auto"
            VerticalOptions="End">
            <HorizontalStackLayout
                Grid.Column="0"
                Spacing="8"
                VerticalOptions="Center">
                <VerticalStackLayout Spacing="0">
                    <Label
                        FontAttributes="Bold"
                        FontSize="14"
                        Text="{Binding OpponentName}"
                        TextColor="White" />

                    <ScrollView Orientation="Horizontal" 
                                HeightRequest="35" 
                                HorizontalScrollBarVisibility="Never">
                        <HorizontalStackLayout BindableLayout.ItemsSource="{Binding OpponentCapturedPieces}" 
                                               Spacing="8">
                            <BindableLayout.ItemTemplate>
                                <DataTemplate x:DataType="logic:CapturedPieceGroup">
                                    <Grid WidthRequest="30" HeightRequest="30">
                                        <Image Source="{Binding ImageSource}" 
                                               Aspect="AspectFit"
                                               HorizontalOptions="Center"
                                               VerticalOptions="Center"
                                               HeightRequest="28" 
                                               WidthRequest="28" 
                                               Opacity="0.9" />

                                        <Border BackgroundColor="#FF4444"
                                                StrokeThickness="0"
                                                StrokeShape="RoundRectangle 8"
                                                VerticalOptions="End"
                                                HorizontalOptions="End"
                                                TranslationX="2"
                                                TranslationY="2"
                                                Padding="3,0"
                                                MinimumWidthRequest="16"
                                                IsVisible="{Binding ShowCount}">
                                            <Label Text="{Binding Count}"
                                                   TextColor="White"
                                                   FontSize="10"
                                                   FontAttributes="Bold"
                                                   HorizontalOptions="Center"
                                                   VerticalOptions="Center" />
                                        </Border>
                                    </Grid>
                                </DataTemplate>
                            </BindableLayout.ItemTemplate>
                        </HorizontalStackLayout>
                    </ScrollView>
                </VerticalStackLayout>
            </HorizontalStackLayout>

            <Border
                Grid.Column="1"
                Padding="10,5"
                Background="#333333"
                Stroke="#555555"
                StrokeThickness="1">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="5" />
                </Border.StrokeShape>
                <Label
                    FontFamily="monospace"
                    FontSize="24"
                    Text="{Binding OpponentTime}"
                    TextColor="#FF4444" />
            </Border>
        </Grid>

        <Label
            Margin="0,5"
            FontAttributes="Italic"
            FontSize="14"
            HorizontalOptions="Center"
            Opacity="0.9"
            Text="{Binding StatusMessage}"
            TextColor="White" />

        <Grid
            x:Name="grdBoard"
            BackgroundColor="#B58863"
            ColumnSpacing="0"
            HorizontalOptions="Center"
            RowSpacing="0"
            VerticalOptions="Center" />

        <Grid
            Margin="0,8,0,0"
            ColumnDefinitions="*, Auto"
            VerticalOptions="Start">
            <HorizontalStackLayout
                Grid.Column="0"
                Spacing="8"
                VerticalOptions="Center">
                <VerticalStackLayout Spacing="0">
                    <Label
                        FontAttributes="Bold"
                        FontSize="14"
                        Text="{Binding MyName}"
                        TextColor="White" />
                    <ScrollView Orientation="Horizontal" 
                                HeightRequest="35" 
                                HorizontalScrollBarVisibility="Never">
                        <HorizontalStackLayout BindableLayout.ItemsSource="{Binding MyCapturedPieces}" 
                                               Spacing="8">
                            <BindableLayout.ItemTemplate>
                                <DataTemplate x:DataType="logic:CapturedPieceGroup">
                                    <Grid WidthRequest="30" HeightRequest="30">
                                        <Image Source="{Binding ImageSource}" 
                                               Aspect="AspectFit"
                                               HorizontalOptions="Center"
                                               VerticalOptions="Center"
                                               HeightRequest="28" 
                                               WidthRequest="28" 
                                               Opacity="0.9" />

                                        <Border BackgroundColor="#FF4444"
                                                StrokeThickness="0"
                                                StrokeShape="RoundRectangle 8"
                                                VerticalOptions="End"
                                                HorizontalOptions="End"
                                                TranslationX="2"
                                                TranslationY="2"
                                                Padding="3,0"
                                                MinimumWidthRequest="16"
                                                IsVisible="{Binding ShowCount}">
                                            <Label Text="{Binding Count}"
                                                   TextColor="White"
                                                   FontSize="10"
                                                   FontAttributes="Bold"
                                                   HorizontalOptions="Center"
                                                   VerticalOptions="Center" />
                                        </Border>
                                    </Grid>
                                </DataTemplate>
                            </BindableLayout.ItemTemplate>
                        </HorizontalStackLayout>
                    </ScrollView>
                </VerticalStackLayout>
            </HorizontalStackLayout>

            <Border
                Grid.Column="1"
                Padding="10,5"
                Background="#252525"
                Stroke="#2196F3"
                StrokeThickness="2">
                <Border.StrokeShape>
                    <RoundRectangle CornerRadius="5" />
                </Border.StrokeShape>
                <Label
                    FontFamily="monospace"
                    FontSize="24"
                    Text="{Binding MyTime}"
                    TextColor="White" />
            </Border>
        </Grid>

        <Button
            Margin="0,25"
            BackgroundColor="Transparent"
            BorderColor="#FF4B4B"
            BorderWidth="2"
            Command="{Binding ResignCommand}"
            CornerRadius="22"
            FontAttributes="Bold"
            FontSize="16"
            HeightRequest="44"
            HorizontalOptions="Center"
            Text="RESIGN"
            TextColor="#FF4B4B"
            WidthRequest="130" />

    </VerticalStackLayout>
</ContentPage>